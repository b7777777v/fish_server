# 座位和砲台測試指南

## 問題診斷

如果您遇到以下問題：
1. **砲台只有一個，其他三個都沒畫出來**
2. **發射也還是不會追蹤滑鼠的方向**

請按照以下步驟測試。

---

## 測試方法 1：使用測試渲染器（推薦）

這會添加 4 個測試玩家到不同的座位，用於驗證渲染功能。

### 步驟：

1. **打開遊戲頁面**
   - 在瀏覽器中打開 `js/index.html`

2. **點擊「🧪 測試渲染器」按鈕**
   - 這會自動添加 4 個玩家（player1-4）到 4 個不同座位
   - 不需要連接伺服器

3. **檢查畫布**
   - 您應該看到 **4 個砲台**：
     - **底部中央**（綠色）- player1（當前玩家）
     - **頂部中央**（灰色）- player2
     - **左側中央**（灰色）- player3
     - **右側中央**（灰色）- player4
   - 每個砲台旁邊都有座位標籤和玩家ID

4. **測試滑鼠追蹤**
   - 移動滑鼠在畫布上
   - **只有 player1（底部綠色砲台）** 會跟隨滑鼠方向旋轉
   - 其他砲台保持固定方向

5. **檢查控制台日誌**
   - 按 F12 打開開發者工具
   - 查看 Console 標籤
   - 應該看到：
     ```
     [Renderer] Test data added: 4 fishes, 2 bullets 4 players
     [Renderer] Players in different seats:
       player1: seat 0, angle -90.0°
       player2: seat 1, angle 90.0°
       player3: seat 2, angle 0.0°
       player4: seat 3, angle 180.0°
     ```

---

## 測試方法 2：實際遊戲測試

這是在真實遊戲環境中測試座位選擇和多人遊戲。

### 單人測試步驟：

1. **啟動遊戲伺服器**
   ```bash
   make run-game
   # 或
   go run cmd/game/main.go
   ```

2. **登入遊戲**
   - 點擊「🚀 遊客登入並開始遊戲」
   - 或使用玩家ID登入

3. **加入房間**
   - 點擊「📋 獲取房間列表」
   - 選擇一個房間加入

4. **選擇座位**
   - 在「🪑 選擇座位」面板中
   - 點擊任一可用座位（座位 1-4）
   - 確認看到提示：「✅ 成功選擇座位 X」

5. **檢查砲台**
   - 畫布上應該出現您的砲台
   - 位置根據您選擇的座位：
     - 座位 1 → 底部中央（向上）
     - 座位 2 → 頂部中央（向下）
     - 座位 3 → 左側中央（向右）
     - 座位 4 → 右側中央（向左）

6. **測試滑鼠控制**
   - 移動滑鼠在畫布上
   - 砲台應該會旋轉跟隨滑鼠
   - 檢查控制台，應該看到角度更新日誌：
     ```
     [Renderer] Updating angle for Guest_XXX: (400, 300) -> 45.0°
     ```

7. **測試發射**
   - 點擊畫布或「🔫 開火」按鈕
   - 子彈應該朝砲台當前指向的方向發射
   - 而不是固定向上

### 多人測試步驟：

1. **打開多個瀏覽器標籤**
   - 標籤 1：遊客登入 → 加入房間 101 → 選擇座位 1
   - 標籤 2：遊客登入 → 加入房間 101 → 選擇座位 2
   - 標籤 3：遊客登入 → 加入房間 101 → 選擇座位 3
   - 標籤 4：遊客登入 → 加入房間 101 → 選擇座位 4

2. **檢查每個標籤**
   - 每個標籤應該看到所有 4 個玩家的砲台
   - 位於不同的座位位置
   - 只有自己的砲台會跟隨滑鼠

---

## 調試輸出

如果遇到問題，請檢查瀏覽器控制台（F12）的輸出：

### 正常情況應該看到：

1. **滑鼠移動**（每 100 幀記錄一次）：
   ```
   [Renderer] Updating angle for player1: (450, 350) -> 30.5°
   ```

2. **砲台繪製**（每 100 幀記錄一次）：
   ```
   [Renderer] Drawing 4 cannons
     - player1: seat 0, pos (600, 750), angle -45.0°
     - player2: seat 1, pos (600, 50), angle 90.0°
     - player3: seat 2, pos (50, 400), angle 0.0°
     - player4: seat 3, pos (1150, 400), angle 180.0°
   ```

3. **座位選擇成功**：
   ```
   ✅ 成功選擇座位 1
   🪑 已將砲台移動到座位 1
   [Client] Added player Guest_XXX to seat 0 from RoomStateUpdate
   ```

### 異常情況：

1. **滑鼠不追蹤**：
   ```
   [Renderer] Mouse move but player XXX not in renderer. Players: ...
   ```
   → 表示玩家沒有正確添加到渲染器

2. **沒有砲台**：
   ```
   [Renderer] Drawing 0 cannons
   ```
   → 表示沒有玩家被添加

3. **條件不滿足**：
   ```
   [Renderer] Mouse move but conditions not met: renderer=true, running=false, playerId=undefined
   ```
   → 檢查 currentPlayerId 是否設置

---

## 常見問題

### Q1: 為什麼只看到一個砲台？

**A:** 有以下可能：
- **測試模式**：沒有點擊「🧪 測試渲染器」按鈕
- **實際遊戲**：房間裡只有您一個玩家（這是正常的）
- **需要其他玩家**：打開多個標籤模擬多人遊戲

### Q2: 為什麼砲台不跟隨滑鼠？

**A:** 檢查：
1. 是否已經選擇座位？（必須選座位才能控制）
2. 是否是您自己的砲台？（只能控制自己的砲台）
3. 檢查控制台是否有警告訊息
4. 確保渲染器正在運行（`isRunning: true`）

### Q3: 子彈還是固定向上發射？

**A:** 這應該已經修復，檢查：
1. 砲台是否跟隨滑鼠旋轉？
2. 控制台是否顯示角度更新？
3. 發射時是否使用了正確的角度？

---

## 技術說明

### 座位位置映射：

```javascript
座位 0 (索引0): { x: 600,  y: 750,  angle: -90° }  // 底部 → 向上
座位 1 (索引1): { x: 600,  y: 50,   angle: 90° }   // 頂部 → 向下
座位 2 (索引2): { x: 50,   y: 400,  angle: 0° }    // 左側 → 向右
座位 3 (索引3): { x: 1150, y: 400,  angle: 180° }  // 右側 → 向左
```

### 角度說明：

- 0° = 向右
- 90° = 向下
- -90° = 向上
- 180° = 向左

### 滑鼠追蹤：

- 使用 `Math.atan2(dy, dx)` 計算滑鼠相對砲台的角度
- 每幀更新砲台的 `angle` 屬性
- 子彈發射時使用當前的 `angle` 值

---

## 回報問題

如果問題依然存在，請提供：

1. 瀏覽器控制台的完整日誌（F12 → Console → 右鍵 → Save as...）
2. 測試步驟（使用測試渲染器還是實際遊戲？）
3. 截圖（顯示畫布和控制台）
4. 選擇的座位編號
5. 是否看到任何錯誤訊息

這將幫助我們快速定位問題！
