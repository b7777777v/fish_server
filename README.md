# ğŸŸ Fish Server - å¤šäººæ•é­šéŠæˆ²å…¨ç«¯å°ˆæ¡ˆ

é€™æ˜¯ä¸€å€‹åŠŸèƒ½å®Œæ•´çš„å¤šäººæ•é­šéŠæˆ²å°ˆæ¡ˆï¼ŒåŒ…å«å¾Œç«¯æœå‹™å’Œå‰ç«¯æ¸¬è©¦å®¢æˆ¶ç«¯ã€‚å¾Œç«¯æ¡ç”¨äº†ç¾ä»£åŒ–çš„ Go èªè¨€ã€å¾®æœå‹™æ¶æ§‹å’Œé›²åŸç”ŸæŠ€è¡“ï¼Œå‰ç«¯æä¾›äº†åŸºæ–¼ WebSocket çš„å³æ™‚éŠæˆ²å®¢æˆ¶ç«¯ï¼Œæ—¨åœ¨æä¾›ä¸€å€‹é«˜æ•ˆã€å¯æ“´å±•ä¸”æ˜“æ–¼ç¶­è­·çš„å®Œæ•´è§£æ±ºæ–¹æ¡ˆã€‚

æ­¤å°ˆæ¡ˆä¸åƒ…åŒ…å«äº†å®Œæ•´çš„æ¥­å‹™é‚è¼¯å’Œå‰ç«¯éŠæˆ²ç•Œé¢ï¼Œé‚„æä¾›äº†ä¸€å¥—æ¥µå…¶å®Œå–„çš„æœ¬åœ°é–‹ç™¼ç’°å¢ƒ (`.vscode`)ï¼Œè®“é–‹ç™¼è€…å¯ä»¥å¯¦ç¾ä¸€éµå•Ÿå‹•ã€å¤šç’°å¢ƒåµéŒ¯å’Œè‡ªå‹•åŒ–ä»»å‹™ï¼Œæ¥µå¤§åœ°æå‡äº†é–‹ç™¼æ•ˆç‡ã€‚

> **æœ€æ–°æ›´æ–°**: æ–°å¢å®Œæ•´çš„å‰ç«¯éŠæˆ²å®¢æˆ¶ç«¯ï¼Œæ”¯æŒå³æ™‚éŠæˆ²äº¤äº’ã€æˆ¿é–“ç®¡ç†å’Œå®Œæ•´çš„éŠæˆ²åŠŸèƒ½å±•ç¤ºï¼

## âœ¨ ä¸»è¦åŠŸèƒ½

### å¾Œç«¯æœå‹™
- **å³æ™‚å¤šäººéŠæˆ²**ï¼šä½¿ç”¨ WebSocket å¯¦ç¾ä½å»¶é²çš„å³æ™‚å®¢æˆ¶ç«¯/ä¼ºæœå™¨é€šè¨Šã€‚
- **éŠæˆ²æˆ¿ç®¡ç†**ï¼šå‰µå»ºã€åŠ å…¥ã€é›¢é–‹éŠæˆ²æˆ¿é–“ï¼Œæ”¯æŒå¤šæˆ¿é–“ä¸¦è¡Œã€‚
- **æ ¸å¿ƒéŠæˆ²é‚è¼¯**ï¼šåŒ…æ‹¬é­šç¾¤ç”Ÿæˆã€æ•ç²æ©Ÿç‡ã€åˆ†æ•¸è¨ˆç®—ã€ç ²å°ç³»çµ±ç­‰ã€‚
- **ç©å®¶ç³»çµ±**ï¼šå®Œæ•´çš„ç©å®¶è³‡æ–™ç®¡ç†èˆ‡ JWT èªè­‰ã€‚
- **éŒ¢åŒ…ç³»çµ±**ï¼šç®¡ç†ç©å®¶çš„éŠæˆ²å…§è²¨å¹£ï¼Œæ”¯æŒå‡çµ/è§£å‡ã€å­˜ææ¬¾ç­‰æ“ä½œã€‚
- **å¾Œå°ç®¡ç†**ï¼šæä¾›ä¸€å€‹ç¨ç«‹çš„ `admin` æœå‹™ï¼Œç”¨æ–¼éŠæˆ²ç®¡ç†èˆ‡ç›£æ§ã€‚
- **å¤šç’°å¢ƒæ”¯æ´**ï¼šå®Œæ•´çš„ `DEV`, `STAGING`, `PROD` ç’°å¢ƒéš”é›¢èˆ‡é…ç½®ã€‚

### å‰ç«¯å®¢æˆ¶ç«¯
- **å®Œæ•´éŠæˆ²ç•Œé¢**ï¼šåŸºæ–¼ Canvas çš„ 2D éŠæˆ²æ¸²æŸ“å¼•æ“ã€‚
- **å³æ™‚äº’å‹•**ï¼šWebSocket å³æ™‚é€šè¨Šï¼Œæ”¯æŒæ‰€æœ‰éŠæˆ²æ“ä½œã€‚
- **æˆ¿é–“ç®¡ç†**ï¼šæ”¯æŒæŸ¥çœ‹æˆ¿é–“åˆ—è¡¨ã€åŠ å…¥/é›¢é–‹æˆ¿é–“ã€‚
- **éŠæˆ²åŠŸèƒ½**ï¼šé–‹ç«å°„æ“Šã€åˆ‡æ›ç ²å°ã€é­šç¾¤å‹•ç•«ã€åˆ†æ•¸é¡¯ç¤ºç­‰ã€‚
- **èª¿è©¦å·¥å…·**ï¼šå®Œæ•´çš„æ¶ˆæ¯æ—¥èªŒå’Œç‹€æ…‹ç›£æ§ï¼Œæ–¹ä¾¿é–‹ç™¼èª¿è©¦ã€‚

## ğŸ›ï¸ æ¶æ§‹æ¦‚è¦½

å°ˆæ¡ˆæ¡ç”¨äº†æ¸…æ™°çš„ **Clean Architecture** è¨­è¨ˆç†å¿µï¼Œå°‡æ¥­å‹™é‚è¼¯èˆ‡åŸºç¤è¨­æ–½åˆ†é›¢ã€‚

- **å¾®æœå‹™æ¶æ§‹**ï¼š
  - `game-server`: è™•ç†æ ¸å¿ƒéŠæˆ²é‚è¼¯èˆ‡ç©å®¶äº’å‹• (WebSocket)ã€‚
  - `admin-server`: æä¾› RESTful API ç”¨æ–¼å¾Œå°ç®¡ç†ã€‚
  - `migrator`: ç”¨æ–¼è³‡æ–™åº«é·ç§»ã€‚
- **é€šè¨Š**ï¼š
  - å®¢æˆ¶ç«¯èˆ‡ `game-server` ä¹‹é–“ä½¿ç”¨ **WebSocket**ã€‚
  - æœå‹™å…§éƒ¨æˆ–å°å¤–çš„ API ä½¿ç”¨ **gRPC** å’Œ **RESTful (Gin)**ã€‚
- **è³‡æ–™åº«**ï¼š
  - **PostgreSQL**: ç”¨æ–¼æŒä¹…åŒ–å„²å­˜æ ¸å¿ƒæ¥­å‹™è³‡æ–™ (ç©å®¶ã€éŒ¢åŒ…ç­‰)ã€‚
  - **Redis**: ç”¨æ–¼å¿«å–ã€æœƒè©±ç®¡ç†æˆ–ç™¼å¸ƒ/è¨‚é–±ã€‚
- **ä¾è³´æ³¨å…¥**ï¼šä½¿ç”¨ **Google Wire** ç®¡ç†æœå‹™é–“çš„ä¾è³´é—œä¿‚ï¼Œå¯¦ç¾æ¾è€¦åˆã€‚
- **å®¹å™¨åŒ–**ï¼šæ‰€æœ‰æœå‹™éƒ½è¢«è¨­è¨ˆç‚ºåœ¨ **Docker** ä¸­é‹è¡Œã€‚

## ğŸ› ï¸ æŠ€è¡“æ£§

### å¾Œç«¯æŠ€è¡“
- **èªè¨€**: Go 1.24+
- **Web æ¡†æ¶**: Gin (RESTful API)
- **RPC æ¡†æ¶**: gRPC + Protocol Buffers
- **è³‡æ–™åº«**: PostgreSQL, Redis
- **ORM/è³‡æ–™åº«å·¥å…·**: `database/sql`, `pgx`
- **ä¾è³´æ³¨å…¥**: Google Wire
- **å®¹å™¨åŒ–**: Docker, Docker Compose
- **è³‡æ–™åº«é·ç§»**: golang-migrate
- **æ—¥èªŒ**: `log/slog` (çµæ§‹åŒ–æ—¥èªŒ)
- **é…ç½®ç®¡ç†**: Viper
- **æ¸¬è©¦**: testify
- **WebSocket**: gorilla/websocket
- **JWT**: golang-jwt

### å‰ç«¯æŠ€è¡“
- **èªè¨€**: JavaScript (åŸç”Ÿ)
- **æ¸²æŸ“å¼•æ“**: HTML5 Canvas 2D
- **é€šè¨Šå”è­°**: WebSocket + Protocol Buffers
- **UI æ¡†æ¶**: åŸç”Ÿ HTML/CSS (ç„¡æ¡†æ¶ä¾è³´)

## ğŸš€ å¿«é€Ÿé–‹å§‹

> **ğŸªŸ Windows ç”¨æˆ¶**: è«‹æŸ¥çœ‹ [WINDOWS_GUIDE.md](WINDOWS_GUIDE.md) ç²å–ä¸ä½¿ç”¨ `make` çš„ Windows å°ˆç”¨æŒ‡å—å’Œè…³æœ¬ï¼

### 1. ç’°å¢ƒæº–å‚™

åœ¨é–‹å§‹ä¹‹å‰ï¼Œè«‹ç¢ºä¿æ‚¨å·²å®‰è£ä»¥ä¸‹å·¥å…·ï¼š

- **Go**: 1.24 æˆ–æ›´é«˜ç‰ˆæœ¬
- **Docker** å’Œ **Docker Compose**
- **Make** (Linux/Mac ç”¨æˆ¶) æˆ–æŸ¥çœ‹ [WINDOWS_GUIDE.md](WINDOWS_GUIDE.md) (Windows ç”¨æˆ¶)
- **golang-migrate**: [å®‰è£æŒ‡å—](https://github.com/golang-migrate/migrate/tree/master/cmd/migrate)
- **golangci-lint**: [å®‰è£æŒ‡å—](https://golangci-lint.run/usage/install/)

> **å¯é¸**ï¼šç¾ä»£ç€è¦½å™¨ç”¨æ–¼è¨ªå•å‰ç«¯æ¸¬è©¦å®¢æˆ¶ç«¯ (éœ€æ”¯æŒ WebSocket å’Œ Canvas)

### 2. å°ˆæ¡ˆè¨­å®š

1. **Clone å°ˆæ¡ˆ**

    ```bash
    git clone <repository-url>
    cd fish_server
    ```

2. **è¨­å®šç’°å¢ƒè®Šæ•¸**
    å°ˆæ¡ˆçš„ Docker ç’°å¢ƒä¾è³´ `.env` æª”æ¡ˆã€‚

    ```bash
    # å¾ç¯„æœ¬è¤‡è£½é–‹ç™¼ç’°å¢ƒè¨­å®š
    cp deployments/.env.example deployments/.env.dev
    ```

    > æ‚¨å¯ä»¥æ ¹æ“šéœ€è¦ä¿®æ”¹ `.env.dev` ä¸­çš„è³‡æ–™åº«å¯†ç¢¼æˆ–å…¶ä»–è¨­å®šã€‚

3. **å•Ÿå‹•åŸºç¤è¨­æ–½**
    ä½¿ç”¨ Docker Compose å•Ÿå‹•è³‡æ–™åº« (PostgreSQL, Redis) ç­‰ä¾è³´æœå‹™ã€‚

    **Linux/Mac:**
    ```bash
    make run-dev
    ```

    **Windows:**
    ```cmd
    REM ä½¿ç”¨æ‰¹è™•ç†æ–‡ä»¶
    scripts\start-database.bat

    REM æˆ–ä½¿ç”¨ Docker Compose
    docker-compose -f deployments\docker-compose.dev.yml up -d postgres redis
    ```

    > é€™å°‡æœƒå•Ÿå‹• `deployments/docker-compose.yml` ä¸­å®šç¾©çš„æœå‹™ã€‚é¦–æ¬¡å•Ÿå‹•æœƒéœ€è¦ä¸€äº›æ™‚é–“ä¾†ä¸‹è¼‰é¡åƒã€‚

4. **åŸ·è¡Œè³‡æ–™åº«é·ç§»**
    åœ¨å¦ä¸€å€‹çµ‚ç«¯ä¸­ï¼ŒåŸ·è¡Œä»¥ä¸‹å‘½ä»¤ä¾†åˆå§‹åŒ–è³‡æ–™åº«çµæ§‹ã€‚

    **Linux/Mac:**
    ```bash
    # !! æ³¨æ„ !!
    # Makefile ä¸­çš„ DB_URL å¯èƒ½éœ€è¦æ ¹æ“šæ‚¨çš„ .env.dev è¨­å®šé€²è¡Œèª¿æ•´
    make migrate-up
    ```

    **Windows:**
    ```cmd
    REM ä½¿ç”¨æ‰¹è™•ç†æ–‡ä»¶
    scripts\run-migration.bat up

    REM æˆ–ç›´æ¥ä½¿ç”¨ Go
    go run cmd\migrator\main.go up
    ```

### 3. å•Ÿå‹•æ‡‰ç”¨ç¨‹å¼

#### æ–¹å¼ä¸€ï¼šä½¿ç”¨ VS Code (æ¨è–¦)

æœ¬å°ˆæ¡ˆæä¾›äº†æ¥µå…¶å¼·å¤§çš„ VS Code å¤šç’°å¢ƒé…ç½®ï¼Œå¼·çƒˆå»ºè­°ä½¿ç”¨ã€‚

1. åœ¨ VS Code ä¸­æ‰“é–‹ `fish_server.code-workspace` å·¥ä½œå€ã€‚
2. æ‰“é–‹ "Run and Debug" å´é‚Šæ¬„ (Ctrl+Shift+D)ã€‚
3. å¾é ‚éƒ¨çš„ä¸‹æ‹‰åˆ—è¡¨ä¸­é¸æ“‡ä¸€å€‹å•Ÿå‹•é¸é …ï¼Œä¾‹å¦‚ï¼š
    - `ğŸš€ DEV Environment - All Services`: ä¸€éµå•Ÿå‹•æ‰€æœ‰é–‹ç™¼ç’°å¢ƒæœå‹™ã€‚
    - `ğŸŸ¢ Admin Server - DEV (Pprof ON)`: å–®ç¨å•Ÿå‹• Admin æœå‹™ã€‚
    - `ğŸ” Debug Admin with Delve`: å•Ÿå‹•ä¸¦åµéŒ¯ Admin æœå‹™ã€‚
4. æŒ‰ä¸‹ `F5` å³å¯å•Ÿå‹•ã€‚

> é—œæ–¼ VS Code ç’°å¢ƒçš„è©³ç´°ç”¨æ³•ï¼Œè«‹åƒè€ƒ [.vscode/README.md](.vscode/README.md)ã€‚

#### æ–¹å¼äºŒï¼šä½¿ç”¨ `make` å‘½ä»¤

æ‚¨ä¹Ÿå¯ä»¥ä½¿ç”¨ `Makefile` ä¸­çš„å‘½ä»¤ä¾†æ‰‹å‹•ç·¨è­¯å’ŒåŸ·è¡Œã€‚

```bash
# ç·¨è­¯æ‰€æœ‰æœå‹™
make build

# å–®ç¨é‹è¡Œ Game Server
make run-game

# å–®ç¨é‹è¡Œ Admin Server
make run-admin
```

### 4. å»ºç«‹æ¸¬è©¦ç©å®¶è³¬è™Ÿ ğŸ®

åœ¨é–‹å§‹éŠæˆ²ä¹‹å‰ï¼Œéœ€è¦å‰µå»ºæ¸¬è©¦ç©å®¶è³¬è™Ÿã€‚æœ¬å°ˆæ¡ˆæä¾›**é€šé Admin Server REST API** å‰µå»ºæœƒå“¡çš„å®Œæ•´æµç¨‹ã€‚

> **ğŸ“š å®Œæ•´ API æ–‡æª”**: [API_TESTING_GUIDE.md](docs/API_TESTING_GUIDE.md)

#### æ–¹å¼ä¸€ï¼šä½¿ç”¨è…³æœ¬ï¼ˆæ¨è–¦ï¼‰

**å¿«é€Ÿå‰µå»ºå–®å€‹æ¸¬è©¦ç©å®¶ï¼š**

```bash
# Linux/Mac
./scripts/create-player-via-api.sh player1 test123456

# è¼¸å‡º:
# âœ… æ³¨å†ŒæˆåŠŸ!
#    ç”¨æˆ· ID: 1
#    æ˜µç§°: player1
#    Token: eyJhbGciOiJIUzI1NiIs...
```

**å®Œæ•´æ¸¸æˆ²æµç¨‹æ¸¬è©¦ï¼š**

```bash
# æ¸¬è©¦å®Œæ•´æµç¨‹ï¼šè¨»å†Š â†’ ç™»å…¥ â†’ é©—è­‰ â†’ é€£æ¥éŠæˆ²
./scripts/test-game-flow-via-api.sh myplayer mypassword

# è¼¸å‡ºå®Œæ•´çš„æ¸¬è©¦å ±å‘Šå’Œé€£æ¥ä¿¡æ¯
```

#### æ–¹å¼äºŒï¼šç›´æ¥ä½¿ç”¨ API

**1. è¨»å†Šæ–°ç”¨æˆ¶**

```bash
curl -X POST http://localhost:6060/api/v1/auth/register \
  -H "Content-Type: application/json" \
  -d '{
    "username": "player1",
    "password": "test123456"
  }'
```

**éŸ¿æ‡‰ï¼š**
```json
{
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "user": {
    "id": 1,
    "username": "player1",
    "nickname": "player1",
    "is_guest": false
  }
}
```

**2. ä½¿ç”¨ Token ç²å–ç”¨æˆ¶è³‡æ–™**

```bash
TOKEN="<your_token_here>"

curl -X GET http://localhost:6060/api/v1/user/profile \
  -H "Authorization: Bearer $TOKEN"
```

**3. é€£æ¥åˆ°éŠæˆ²æœå‹™å™¨**

ä½¿ç”¨ç²å–çš„ Token é€šé WebSocket é€£æ¥ï¼š

```
ws://localhost:9090?token=<your_token>
```

#### å¯ç”¨çš„ API ç«¯é»

| ç«¯é» | æ–¹æ³• | èªªæ˜ |
|------|------|------|
| `/api/v1/auth/register` | POST | è¨»å†Šæ–°ç”¨æˆ¶ |
| `/api/v1/auth/login` | POST | ç”¨æˆ¶ç™»å…¥ |
| `/api/v1/auth/guest-login` | POST | æ¸¸å®¢ç™»å…¥ |
| `/api/v1/user/profile` | GET | ç²å–ç”¨æˆ¶è³‡æ–™ |
| `/api/v1/user/profile` | PUT | æ›´æ–°ç”¨æˆ¶è³‡æ–™ |

> **è©³ç´°æ–‡æª”**: æŸ¥çœ‹ [API_TESTING_GUIDE.md](docs/API_TESTING_GUIDE.md) ç²å–å®Œæ•´çš„ API æ–‡æª”ã€è«‹æ±‚ç¤ºä¾‹å’Œæ•…éšœæ’é™¤æŒ‡å—ã€‚

#### æ‰¹é‡å‰µå»ºæ¸¬è©¦ç©å®¶

```bash
# å‰µå»º 4 å€‹æ¸¬è©¦ç©å®¶ç”¨æ–¼å¤šäººéŠæˆ²æ¸¬è©¦
for i in {1..4}; do
  ./scripts/create-player-via-api.sh "player$i" "test123"
  sleep 1
done
```

### 5. è¨ªå•å‰ç«¯æ¸¬è©¦å®¢æˆ¶ç«¯

å‰ç«¯æ¸¬è©¦å®¢æˆ¶ç«¯å·²ç¶“é›†æˆåˆ° `admin-server` ä¸­ï¼Œç„¡éœ€é¡å¤–å•Ÿå‹•æœå‹™ã€‚

#### è¨ªå•æ–¹å¼

ç¢ºä¿ Admin Server å·²ç¶“å•Ÿå‹•ï¼ˆé»˜èªç«¯å£ï¼š6060ï¼‰ï¼Œç„¶å¾Œåœ¨ç€è¦½å™¨ä¸­è¨ªå•ï¼š

```
http://localhost:6060/test-client
```

> **æç¤º**ï¼šå‰ç«¯æ¸¬è©¦å®¢æˆ¶ç«¯æ˜¯å°ˆé–€ç”¨ä¾†æª¢æ¸¬å’Œèª¿è©¦ Game Server çš„å·¥å…·ï¼Œå› æ­¤é›†æˆåˆ° Admin Server ä¸­æœ€ç‚ºåˆé©ã€‚

#### ä½¿ç”¨èªªæ˜

1. **è¨­å®šæœå‹™å™¨åœ°å€**ï¼šåœ¨é é¢é ‚éƒ¨è¼¸å…¥éŠæˆ²æœå‹™å™¨åœ°å€ï¼ˆé»˜èªï¼š`ws://localhost:9090/ws`ï¼‰
2. **è¼¸å…¥ç©å®¶ä¿¡æ¯**ï¼šè¼¸å…¥ç©å®¶ ID å’Œ Tokenï¼ˆæ¸¬è©¦ç’°å¢ƒå¯ä½¿ç”¨ä»»æ„å€¼ï¼‰
3. **é€£æ¥æœå‹™å™¨**ï¼šé»æ“Šã€Œé€£æ¥ã€æŒ‰éˆ•å»ºç«‹ WebSocket é€£æ¥
4. **é–‹å§‹éŠæˆ²**ï¼š
   - é»æ“Šã€Œç²å–æˆ¿é–“åˆ—è¡¨ã€æŸ¥çœ‹å¯ç”¨æˆ¿é–“
   - é»æ“Šã€ŒåŠ å…¥æˆ¿é–“ã€é€²å…¥éŠæˆ²
   - ä½¿ç”¨ã€Œé–‹ç«ã€æŒ‰éˆ•æˆ–é»æ“ŠéŠæˆ²ç•«é¢å°„æ“Š
   - ä½¿ç”¨ã€Œåˆ‡æ›ç ²å°ã€æŒ‰éˆ•åˆ‡æ›ä¸åŒå¨åŠ›çš„ç ²å°
5. **æŸ¥çœ‹æ—¥èªŒ**ï¼šæ‰€æœ‰ WebSocket æ¶ˆæ¯éƒ½æœƒåœ¨å³å´æ—¥èªŒå€åŸŸé¡¯ç¤ºï¼Œæ–¹ä¾¿èª¿è©¦

> **æç¤º**ï¼šç¢ºä¿éŠæˆ²æœå‹™å™¨å·²ç¶“å•Ÿå‹•ä¸¦é‹è¡Œåœ¨ `localhost:9090`ï¼Œå¦å‰‡ç„¡æ³•é€£æ¥ã€‚

## âš™ï¸ é…ç½®

å°ˆæ¡ˆä½¿ç”¨ `Viper` ä¾†ç®¡ç†é…ç½®ï¼Œæ”¯æŒå¾é…ç½®æ–‡ä»¶ã€ç’°å¢ƒè®Šæ•¸ç­‰å¤šç¨®ä¾†æºè®€å–é…ç½®ã€‚

### é…ç½®æ–‡ä»¶

ä¸»è¦çš„é…ç½®æ–‡ä»¶æ˜¯ `configs/config.yaml`ï¼Œå…¶ä¸­å®šç¾©äº†æ‰€æœ‰å¯ç”¨çš„é…ç½®é …åŠå…¶é»˜èªå€¼ã€‚

```yaml
# configs/config.yaml
log:
  level: "debug" # å¯é¸å€¼: debug, info, warn, error
  format: "json" # å¯é¸å€¼: json, console

server:
  game:
    port: "9090"
  admin:
    port: "6060"

data:
  database:
    driver: "postgres"
    host: "localhost"
    port: 5432
    user: "user"
    password: "password"
    dbname: "fish_db"
    sslmode: "disable"
  redis:
    addr: "localhost:6379"
    password: ""
    db: 0

jwt:
  secret: "your-super-secret-key" # å‹™å¿…ä¿®æ”¹æˆä¸€å€‹è¤‡é›œçš„å¯†é‘°
  issuer: "fish_server" # token ç™¼è¡Œè€…
  expire: 7200 # token éæœŸæ™‚é–“ï¼Œå–®ä½ç‚ºç§’ (ä¾‹å¦‚ 7200 è¡¨ç¤º 2 å°æ™‚)
```

### ç’°å¢ƒè®Šæ•¸

æ‚¨å¯ä»¥ä½¿ç”¨ç’°å¢ƒè®Šæ•¸ä¾†è¦†è“‹é…ç½®æ–‡ä»¶ä¸­çš„å€¼ã€‚ç’°å¢ƒè®Šæ•¸çš„å‘½åè¦å‰‡æ˜¯ `[SECTION]_[KEY]`ï¼Œä¾‹å¦‚ï¼š

```bash
export SERVER_GAME_PORT=9091
```

## ğŸŸ éŠæˆ²é‚è¼¯

### é­šç¾¤è·¯ç·šå’Œé™£å‹

éŠæˆ²ä¸­çš„é­šç¾¤è¡Œç‚ºç”±è·¯ç·šå’Œé™£å‹ç³»çµ±æ§åˆ¶ã€‚

#### é™£å‹é¡å‹

- **Vå­—å‹** (`FormationTypeV`)
- **ç›´ç·šå‹** (`FormationTypeLine`)
- **åœ“å½¢** (`FormationTypeCircle`)
- **ä¸‰è§’å½¢** (`FormationTypeTriangle`)
- **è±å½¢** (`FormationTypeDiamond`)
- **æ³¢æµªå‹** (`FormationTypeWave`)
- **èºæ—‹å‹** (`FormationTypeSpiral`)

#### è·¯ç·šé¡å‹

- **ç›´ç·šè·¯ç·š**
- **æ›²ç·šè·¯ç·š**
- **Zå­—å‹è·¯ç·š**
- **åœ“å½¢è·¯ç·š**
- **èºæ—‹è·¯ç·š**
- **æ³¢æµªè·¯ç·š**
- **ä¸‰è§’å·¡é‚**
- **éš¨æ©Ÿè·¯ç·š**

è©³ç´°ä¿¡æ¯è«‹åƒè€ƒ [FISH_FORMATION_GUIDE.md](FISH_FORMATION_GUIDE.md)ã€‚

## ğŸ® éŠæˆ²å®¢æˆ¶ç«¯

### å‰ç«¯æ•¸æ“šæ¨é€

å¾Œç«¯æœƒé€šé WebSocket å‘å‰ç«¯æ¨é€éŠæˆ²ç‹€æ…‹å’Œäº‹ä»¶ã€‚

#### æ¶ˆæ¯é¡å‹

- `ROOM_STATE_UPDATE`: å®šæœŸæ¨é€çš„å®Œæ•´æˆ¿é–“ç‹€æ…‹ã€‚
- `FORMATION_SPAWNED`: é­šç¾¤é™£å‹ç”Ÿæˆäº‹ä»¶ã€‚
- `FISH_SPAWNED`: å–®å€‹é­šç”Ÿæˆäº‹ä»¶ã€‚
- `FISH_DIED`: é­šæ­»äº¡äº‹ä»¶ã€‚
- `BULLET_FIRED`: å­å½ˆç™¼å°„äº‹ä»¶ã€‚

è©³ç´°ä¿¡æ¯è«‹åƒè€ƒ [FRONTEND_FISH_DYNAMICS_GUIDE.md](FRONTEND_FISH_DYNAMICS_GUIDE.md)ã€‚

## ğŸ”§ é–‹ç™¼æµç¨‹

### ä»£ç¢¼ç”Ÿæˆ

å°ˆæ¡ˆä½¿ç”¨ `go generate` ä¾†è‡ªå‹•ç”Ÿæˆ Protobuf å’Œ Wire çš„ä»£ç¢¼ã€‚

```bash
# ç”Ÿæˆæ‰€æœ‰ä»£ç¢¼
make gen

# åªç”Ÿæˆ Protobuf ä»£ç¢¼
make proto

# åªç”Ÿæˆ Wire ä¾è³´æ³¨å…¥ä»£ç¢¼
make wire
```

> åœ¨æ–°å¢æˆ–ä¿®æ”¹ `.proto` æª”æ¡ˆæˆ– `wire.go` æª”æ¡ˆå¾Œï¼Œéœ€è¦åŸ·è¡Œé€™äº›å‘½ä»¤ã€‚

### æ¸¬è©¦

```bash
# é‹è¡Œæ‰€æœ‰æ¸¬è©¦
make test

# é‹è¡Œ Linter
make lint
```

### æ¸…ç†

```bash
# æ¸…ç†æ‰€æœ‰ç·¨è­¯ç”¢ç‰©å’Œå¿«å–
make clean
```

## ğŸ“ å°ˆæ¡ˆçµæ§‹

```
.
â”œâ”€â”€ api/                # Protobuf å®šç¾© (éŠæˆ²å”è­°ã€gRPC æœå‹™)
â”œâ”€â”€ cmd/                # ä¸»æ‡‰ç”¨ç¨‹å¼å…¥å£ (main.go)
â”‚   â”œâ”€â”€ admin/          # å¾Œå°ç®¡ç†æœå‹™
â”‚   â”œâ”€â”€ game/           # éŠæˆ²æœå‹™
â”‚   â””â”€â”€ migrator/       # è³‡æ–™åº«é·ç§»å·¥å…·
â”œâ”€â”€ configs/            # ç’°å¢ƒé…ç½®æ–‡ä»¶ (config.yaml)
â”œâ”€â”€ deployments/        # Docker å’Œéƒ¨ç½²ç›¸é—œæ–‡ä»¶
â”œâ”€â”€ docs/               # å°ˆæ¡ˆæ–‡æª”
â”œâ”€â”€ internal/           # å°ˆæ¡ˆå…§éƒ¨ä»£ç¢¼ (ä¸å°å¤–æš´éœ²)
â”‚   â”œâ”€â”€ app/            # æ‡‰ç”¨å±¤: æœå‹™çš„å•Ÿå‹•èˆ‡çµ„ç¹”
â”‚   â”œâ”€â”€ biz/            # æ¥­å‹™é‚è¼¯å±¤: æ ¸å¿ƒæ¥­å‹™å¯¦é«”èˆ‡ç”¨ä¾‹
â”‚   â”œâ”€â”€ conf/           # é…ç½®æ˜ å°„çµæ§‹
â”‚   â”œâ”€â”€ data/           # è³‡æ–™å­˜å–å±¤: Repository å¯¦ç¾
â”‚   â””â”€â”€ pkg/            # å°ˆæ¡ˆå…§éƒ¨å…±äº«çš„å·¥å…·åŒ…
â”œâ”€â”€ js/                 # å‰ç«¯æ¸¬è©¦å®¢æˆ¶ç«¯ â­ æ–°å¢
â”‚   â”œâ”€â”€ index.html      # éŠæˆ²å®¢æˆ¶ç«¯ä¸»é é¢
â”‚   â”œâ”€â”€ game-client.js  # WebSocket å®¢æˆ¶ç«¯å’ŒéŠæˆ²é‚è¼¯
â”‚   â”œâ”€â”€ game-renderer.js # Canvas æ¸²æŸ“å¼•æ“
â”‚   â””â”€â”€ generated/      # Protobuf ç”Ÿæˆçš„ JavaScript ä»£ç¢¼
â”œâ”€â”€ pkg/                # å¯ä¾›å¤–éƒ¨å°ˆæ¡ˆä½¿ç”¨çš„å…±äº«ä»£ç¢¼
â”œâ”€â”€ scripts/            # å„é¡è¼”åŠ©è…³æœ¬ (proto-gen, wire-gen ç­‰)
â”œâ”€â”€ storage/            # è³‡æ–™åº«é·ç§»æ–‡ä»¶
â””â”€â”€ .vscode/            # VS Code å·¥ä½œå€é…ç½®
```

## ğŸ¨ å‰ç«¯å®¢æˆ¶ç«¯é–‹ç™¼

å‰ç«¯æ¸¬è©¦å®¢æˆ¶ç«¯å·²æ•´åˆåˆ° Admin Server ä¸­ï¼Œé€šé `/test-client` è·¯ç”±æä¾›æœå‹™ã€‚å®¢æˆ¶ç«¯æ¡ç”¨æ¨¡çµ„åŒ–è¨­è¨ˆï¼Œä¸»è¦åŒ…å«ä»¥ä¸‹çµ„ä»¶ï¼š

### ä¸»è¦æ¨¡çµ„

1. **game-client.js** - WebSocket å®¢æˆ¶ç«¯
   - è™•ç† WebSocket é€£æ¥å’Œæ¶ˆæ¯æ”¶ç™¼
   - Protobuf æ¶ˆæ¯çš„åºåˆ—åŒ–/ååºåˆ—åŒ–
   - éŠæˆ²ç‹€æ…‹ç®¡ç†

2. **game-renderer.js** - Canvas æ¸²æŸ“å¼•æ“
   - éŠæˆ²ç•«é¢æ¸²æŸ“ï¼ˆé­šç¾¤ã€å­å½ˆã€ç ²å°ç­‰ï¼‰
   - å‹•ç•«è™•ç†å’Œç¢°æ’æª¢æ¸¬
   - UI ç¹ªåˆ¶å’Œäº¤äº’

3. **generated/** - Protobuf ç”Ÿæˆä»£ç¢¼
   - èˆ‡å¾Œç«¯å…±äº«çš„æ¶ˆæ¯å®šç¾©
   - è‡ªå‹•ç”Ÿæˆçš„ JavaScript Protobuf ä»£ç¢¼

### é–‹ç™¼æŒ‡å—

#### è¨ªå•æ¸¬è©¦å®¢æˆ¶ç«¯

1. å•Ÿå‹• Admin Serverï¼š`make run-admin`
2. åœ¨ç€è¦½å™¨ä¸­è¨ªå•ï¼š`http://localhost:6060/test-client`
3. ç¢ºä¿ Game Server ä¹Ÿåœ¨é‹è¡Œï¼ˆé»˜èªç«¯å£ï¼š9090ï¼‰

#### ä¿®æ”¹ Protobuf å®šç¾©å¾Œé‡æ–°ç”Ÿæˆå‰ç«¯ä»£ç¢¼

```bash
# åœ¨é …ç›®æ ¹ç›®éŒ„åŸ·è¡Œ
make proto

# æˆ–æ‰‹å‹•åŸ·è¡Œç”Ÿæˆè…³æœ¬
sh ./scripts/proto-gen.sh
```

ç”Ÿæˆçš„ JavaScript Protobuf ä»£ç¢¼æœƒè‡ªå‹•æ”¾ç½®åœ¨ `js/generated/` ç›®éŒ„ä¸‹ã€‚

#### èª¿è©¦æŠ€å·§

- æ‰“é–‹ç€è¦½å™¨é–‹ç™¼è€…å·¥å…·æŸ¥çœ‹ Console æ—¥èªŒ
- ä½¿ç”¨é é¢å³å´çš„æ¶ˆæ¯æ—¥èªŒæŸ¥çœ‹æ‰€æœ‰ WebSocket é€šè¨Š
- é€šé Network é¢æ¿ç›£æ§ WebSocket é€£æ¥ç‹€æ…‹
- Admin Server æœƒåœ¨å•Ÿå‹•æ™‚é¡¯ç¤ºæ¸¬è©¦å®¢æˆ¶ç«¯çš„è¨ªå•åœ°å€

## ğŸ¤ è²¢ç»

æ­¡è¿æäº¤ Issue å’Œ Pull Requestï¼

åœ¨æäº¤ä»£ç¢¼å‰ï¼Œè«‹ç¢ºä¿ï¼š
- ä»£ç¢¼é€šé `make lint` æª¢æŸ¥
- æ‰€æœ‰æ¸¬è©¦é€šé `make test`
- æ›´æ–°ç›¸é—œæ–‡æª”

## API æ¥å£æ–‡æª”

æœ¬æ–‡ä»¶æ¦‚è¿°äº† `fish_server` å°ˆæ¡ˆä¸­çš„æ‰€æœ‰ä¸»è¦ API æ¥å£ï¼ŒåŒ…æ‹¬å¾Œå°ç®¡ç†çš„ RESTful APIã€éŠæˆ²æ ¸å¿ƒçš„ gRPC æœå‹™ä»¥åŠå®¢æˆ¶ç«¯èˆ‡ä¼ºæœå™¨ä¹‹é–“çš„ WebSocket é€šè¨Šå”è­°ã€‚

### Admin API (RESTful)

æ­¤ API ä¸»è¦ç”¨æ–¼å¾Œå°ç®¡ç†ã€ç›£æ§å’Œæ•¸æ“šæŸ¥è©¢ã€‚æ‰€æœ‰ç«¯é»éƒ½ä»¥ `/admin` ç‚ºå‰ç¶´ã€‚

| æ–¹æ³• (Method) | è·¯å¾‘ (Path)                      | æè¿° (Description)                               |
|---------------|----------------------------------|--------------------------------------------------|
| `GET`         | `/`                              | é¡¯ç¤º API æ ¹ä¿¡æ¯                                  |
| `GET`         | `/ping`                          | ç°¡å–®çš„ Ping-Pong æª¢æŸ¥                            |
| `GET`         | `/admin/health`                  | ä¸€èˆ¬å¥åº·æª¢æŸ¥                                     |
| `GET`         | `/admin/health/live`             | Kubernetes å­˜æ´»æ¢æ¸¬ (Liveness Probe)             |
| `GET`         | `/admin/health/ready`            | Kubernetes å°±ç·’æ¢æ¸¬ (Readiness Probe)            |
| `GET`         | `/admin/status`                  | ç²å–è©³ç´°çš„ä¼ºæœå™¨é‹è¡Œç‹€æ…‹ (è¨˜æ†¶é«”ã€å”ç¨‹ç­‰)        |
| `GET`         | `/admin/metrics`                 | ç²å– Prometheus æ ¼å¼çš„è©³ç´°æŒ‡æ¨™                   |
| `GET`         | `/admin/env`                     | ç²å–ç•¶å‰ç’°å¢ƒé…ç½®ä¿¡æ¯                           |
| `GET`         | `/admin/players/:id`             | ç²å–æŒ‡å®š ID çš„ç©å®¶ä¿¡æ¯                           |
| `GET`         | `/admin/players/:id/wallets`     | ç²å–æŒ‡å®šç©å®¶çš„æ‰€æœ‰éŒ¢åŒ…                           |
| `GET`         | `/admin/wallets/:id`             | ç²å–æŒ‡å®š ID çš„éŒ¢åŒ…ä¿¡æ¯                           |
| `GET`         | `/admin/wallets/:id/transactions`| ç²å–æŒ‡å®šéŒ¢åŒ…çš„äº¤æ˜“è¨˜éŒ„                           |
| `POST`        | `/admin/wallets/:id/freeze`      | å‡çµæŒ‡å®šéŒ¢åŒ…                                     |
| `POST`        | `/admin/wallets/:id/unfreeze`    | è§£å‡æŒ‡å®šéŒ¢åŒ…                                     |
| `POST`        | `/admin/wallets/:id/deposit`     | å‘æŒ‡å®šéŒ¢åŒ…å­˜æ¬¾ (å¢åŠ é¤˜é¡)                        |
| `POST`        | `/admin/wallets/:id/withdraw`    | å¾æŒ‡å®šéŒ¢åŒ…ææ¬¾ (æ¸›å°‘é¤˜é¡)                        |
| `GET`         | `/debug/pprof/*`                 | (å¯é¸) Go pprof æ€§èƒ½åˆ†æç«¯é»                     |

### éŠæˆ²æœå‹™ (gRPC)

æ­¤æœå‹™ç”¨æ–¼éœ€è¦å¾Œç«¯é©—è­‰æˆ–è™•ç†çš„éŠæˆ²ç›¸é—œæ“ä½œï¼Œä¾‹å¦‚ç™»å…¥ã€‚

**æœå‹™åç¨±**: `v1.Game`

| RPC æ–¹æ³• (Method) | è«‹æ±‚ (Request)         | å›æ‡‰ (Response)        | æè¿° (Description) |
|-------------------|------------------------|------------------------|--------------------|
| `Login`           | `v1.LoginRequest`      | `v1.LoginResponse`     | ç©å®¶å¸³è™Ÿå¯†ç¢¼ç™»å…¥   |

### éŠæˆ²å®¢æˆ¶ç«¯é€šè¨Š (WebSocket)

å®¢æˆ¶ç«¯èˆ‡éŠæˆ²ä¼ºæœå™¨ä¹‹é–“çš„ä¸»è¦é€šè¨Šæ–¹å¼ã€‚æ‰€æœ‰æ¶ˆæ¯éƒ½å°è£åœ¨ `v1.GameMessage` ä¸­ï¼Œé€šé `MessageType` æšèˆ‰ä¾†å€åˆ†ã€‚

#### æ¶ˆæ¯æ–¹å‘

*   **C -> S**: å®¢æˆ¶ç«¯ç™¼é€åˆ°ä¼ºæœå™¨
*   **S -> C**: ä¼ºæœå™¨ç™¼é€åˆ°å®¢æˆ¶ç«¯ (å–®æ’­æˆ–å»£æ’­)

#### æ¶ˆæ¯é¡å‹ (`v1.MessageType`)

| é¡å‹ (Type)                | æ–¹å‘   | æ•¸æ“šçµæ§‹ (Payload)             | æè¿° (Description)                               |
|----------------------------|--------|--------------------------------|--------------------------------------------------|
| **å®¢æˆ¶ç«¯è«‹æ±‚**             |        |                                |                                                  |
| `FIRE_BULLET`              | C -> S | `v1.FireBulletRequest`         | ç©å®¶è«‹æ±‚é–‹ç«                                     |
| `SWITCH_CANNON`            | C -> S | `v1.SwitchCannonRequest`       | ç©å®¶è«‹æ±‚åˆ‡æ›ç ²å°                                 |
| `JOIN_ROOM`                | C -> S | `v1.JoinRoomRequest`           | ç©å®¶è«‹æ±‚åŠ å…¥æˆ¿é–“                                 |
| `LEAVE_ROOM`               | C -> S | `v1.LeaveRoomRequest`          | ç©å®¶è«‹æ±‚é›¢é–‹æˆ¿é–“                                 |
| `HEARTBEAT`                | C -> S | `v1.HeartbeatMessage`          | å®¢æˆ¶ç«¯ç™¼é€å¿ƒè·³ä»¥ä¿æŒé€£æ¥                         |
| `GET_ROOM_LIST`            | C -> S | `v1.GetRoomListRequest`        | è«‹æ±‚ç²å–ç•¶å‰å¯ç”¨çš„æˆ¿é–“åˆ—è¡¨                       |
| `GET_PLAYER_INFO`          | C -> S | `v1.GetPlayerInfoRequest`      | è«‹æ±‚ç²å–ç•¶å‰ç©å®¶çš„è©³ç´°ä¿¡æ¯                       |
| **ä¼ºæœå™¨å›æ‡‰**             |        |                                |                                                  |
| `FIRE_BULLET_RESPONSE`     | S -> C | `v1.FireBulletResponse`        | å°é–‹ç«è«‹æ±‚çš„å›æ‡‰ (æˆåŠŸã€å­å½ˆ IDã€èŠ±è²»)           |
| `SWITCH_CANNON_RESPONSE`   | S -> C | `v1.SwitchCannonResponse`      | å°åˆ‡æ›ç ²å°è«‹æ±‚çš„å›æ‡‰                             |
| `JOIN_ROOM_RESPONSE`       | S -> C | `v1.JoinRoomResponse`          | å°åŠ å…¥æˆ¿é–“è«‹æ±‚çš„å›æ‡‰                             |
| `LEAVE_ROOM_RESPONSE`      | S -> C | `v1.LeaveRoomResponse`         | å°é›¢é–‹æˆ¿é–“è«‹æ±‚çš„å›æ‡‰                             |
| `HEARTBEAT_RESPONSE`       | S -> C | `v1.HeartbeatResponse`         | å°å¿ƒè·³è«‹æ±‚çš„å›æ‡‰                                 |
| `ROOM_LIST_RESPONSE`       | S -> C | `v1.RoomListResponse`          | å›æ‡‰æˆ¿é–“åˆ—è¡¨                                     |
| `PLAYER_INFO_RESPONSE`     | S -> C | `v1.PlayerInfoResponse`        | å›æ‡‰ç©å®¶è©³ç´°ä¿¡æ¯                                 |
| **ä¼ºæœå™¨å»£æ’­äº‹ä»¶**         |        |                                |                                                  |
| `BULLET_FIRED`             | S -> C | `v1.BulletFiredEvent`          | å»£æ’­æˆ¿é–“å…§æœ‰ç©å®¶é–‹ç«                             |
| `CANNON_SWITCHED`          | S -> C | `v1.CannonSwitchedEvent`       | å»£æ’­æˆ¿é–“å…§æœ‰ç©å®¶åˆ‡æ›ç ²å°                         |
| `FISH_SPAWNED`             | S -> C | `v1.FishSpawnedEvent`          | å»£æ’­å ´æ™¯ä¸­ç”Ÿæˆäº†æ–°çš„é­šç¾¤                         |
| `FISH_DIED`                | S -> C | `v1.FishDiedEvent`             | å»£æ’­æœ‰é­šè¢«æ•ç² (åŒ…å«çå‹µä¿¡æ¯)                    |
| `PLAYER_REWARD`            | S -> C | `v1.PlayerRewardEvent`         | å»£æ’­ç©å®¶ç²å¾—çå‹µ (å¯ç”¨æ–¼éæ•é­šçå‹µ)              |
| `WELCOME`                  | S -> C | `v1.WelcomeMessage`            | ç©å®¶æˆåŠŸé€£æ¥å¾Œï¼Œä¼ºæœå™¨ç™¼é€çš„ç¬¬ä¸€æ¢æ­¡è¿æ¶ˆæ¯       |
| `PLAYER_JOINED`            | S -> C | `v1.PlayerJoinedMessage`       | å»£æ’­æœ‰æ–°ç©å®¶åŠ å…¥æˆ¿é–“                             |
| `PLAYER_LEFT`              | S -> C | `v1.PlayerLeftMessage`         | å»£æ’­æœ‰ç©å®¶é›¢é–‹æˆ¿é–“                               |
| **éŒ¯èª¤**                   |        |                                |                                                  |
| `ERROR`                    | S -> C | `v1.ErrorMessage`              | ç•¶ç™¼ç”ŸéŒ¯èª¤æ™‚ï¼Œä¼ºæœå™¨å‘å®¢æˆ¶ç«¯ç™¼é€éŒ¯èª¤ä¿¡æ¯         |
