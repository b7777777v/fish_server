### **產品需求文件 (PRD) - Fish Server**

**版本**: 1.1 (優化版)
**日期**: 2025年11月10日

### **1. 簡介 (Introduction)**

本文件旨在詳細說明「Fish Server」專案的產品需求。Fish Server 是一個為多人即時捕魚射擊遊戲設計的高性能後端系統。

系統的核心是提供一個穩定、可擴展且易於管理的遊戲環境。根據程式碼庫分析，此專案由兩個主要服務組成：

1.  **遊戲伺服器 (Game Server)**:
    *   **用途**: 處理核心遊戲邏輯、玩家連線及即時狀態同步。
    *   **技術**: 使用 Go 語言開發，透過 **WebSocket** 與遊戲客戶端進行高效的即時雙向通訊，並輔以 gRPC 進行內部服務通訊。

2.  **後台管理伺服器 (Admin Server)**:
    *   **用途**: 提供一個 RESTful API，供遊戲營運人員監控、管理和即時調整線上遊戲參數。
    *   **關鍵特色**: 支援 **遊戲設定熱更新 (Hot-Reload)**，允許營運人員在不停機的狀況下，動態調整例如魚群陣型、生成機率等核心遊戲參數。

### **2. 產品目標 (Product Goals)**

#### **2.1. 商業目標**
*   **提升玩家參與度**: 透過動態、不可預測且豐富的魚群陣型和事件，創造引人入勝的遊戲體驗。
*   **實現高效營運**: 賦予營運團隊強大的工具，能夠即時調整遊戲經濟模型 (如 RTP 控制) 和內容，以應對市場變化和玩家行為。
*   **最大化在線時間**: 透過不停機更新和穩定的架構，最小化維護時間，確保玩家可以 7x24 小時遊玩。

#### **2.2. 技術目標**
*   **低延遲效能**: 確保客戶端和伺服器之間的指令與事件延遲降至最低，提供流暢的即時互動感受。
*   **高併發擴展性**: 架構設計需能支援大量玩家同時在線，並能透過水平擴展遊戲伺服器來承載更多負載。
*   **可維護性與模組化**: 保持清晰的程式碼結構 (如 `biz`, `data`, `app` 分層)，將商業邏輯、資料存取和 API 介面分離，便於未來的功能迭代和維護。
*   **動態配置能力**: 核心目標之一。必須完美支援從後台管理系統推送設定到線上遊戲伺服器，並立即生效，這是此專案的關鍵架構優勢。

#### **2.3. 成功指標 (Success Metrics)**
*   **[M-1] 每日活躍使用者 (DAU)**: 上線後三個月內達到 1,000+。
*   **[M-2] 使用者平均在線時長**: 穩定在 30 分鐘/日以上。
*   **[M-3] 伺服器可用性**: 核心服務達到 99.9% 的可用性。

### **3. 目標使用者 (Target Users)**
*   **街機遊戲愛好者**: 喜歡傳統街機捕魚遊戲，追求爽快打擊感和金幣爆發的玩家。
*   **休閒遊戲玩家**: 尋求快速、刺激、無太大上手門檻的遊戲體驗的玩家。
*   **社交競技者**: 喜歡與朋友或其他線上玩家進行輕度競技，享受共同遊戲樂趣的使用者。

### **4. 系統架構與設計 (System Architecture & Design)**

Fish Server 採用微服務架構，主要由以下核心組件構成：

#### **4.1. 核心服務 (Core Services)**

*   **Game Server (遊戲伺服器)**:
    *   **技術棧**: Go 語言。
    *   **職責**:
        *   管理 WebSocket 連線。
        *   處理遊戲房間的建立、加入、離開。
        *   執行核心遊戲邏輯 (魚群生成、子彈發射、碰撞檢測、分數計算)。
        *   管理玩家狀態 (金幣、道具、經驗值)。
        *   透過 gRPC 與其他內部服務通訊 (例如，獲取配置、儲存資料)。
        *   **關鍵模組**: `internal/app/game` (應用層), `internal/biz/game` (業務邏輯層，包含 `RoomManager`, `FishSpawner`, `GameUsecase` 等)。

*   **Admin Server (後台管理伺服器)**:
    *   **技術棧**: Go 語言。
    *   **職責**:
        *   提供 RESTful API 介面供營運人員使用。
        *   管理遊戲配置 (如魚群陣型、難度設定)。
        *   觸發遊戲伺服器的配置熱更新機制。
        *   提供遊戲數據查詢和監控功能。
        *   **關鍵模組**: `internal/app/admin` (應用層，包含 `formation_handlers.go` 等), `internal/biz/admin` (業務邏輯層)。

#### **4.2. 資料層 (Data Layer)**

*   **PostgreSQL (關聯式資料庫)**:
    *   **用途**: 儲存持久化資料，如玩家帳戶、遊戲歷史、魚種定義、配置設定等。
    *   **關鍵模組**: `internal/data/postgres`。
    *   **Schema**: 透過 `storage/migrations` 中的 SQL 腳本進行管理，包含 `game_tables`, `fish_types`, `formation_config` 等。

*   **Redis (記憶體資料庫/快取)**:
    *   **用途**: 儲存即時性、高頻存取的資料，如會話狀態、排行榜、遊戲房間的即時狀態快取。
    *   **關鍵模組**: `internal/data/redis`。

#### **4.3. 通訊協議 (Communication Protocols)**

*   **WebSocket**:
    *   **用途**: 遊戲客戶端與 Game Server 之間的主要即時通訊方式。
    *   **優勢**: 全雙工通訊，低延遲，適合頻繁的遊戲狀態更新。

*   **gRPC (Google Remote Procedure Call)**:
    *   **用途**: 內部服務間 (例如 Game Server 獲取配置、Admin Server 通知 Game Server 更新配置) 的高效通訊。
    *   **優勢**: 基於 Protocol Buffers，高效、跨語言、強型別。
    *   **定義**: `api/proto/v1/game.proto` 定義了遊戲相關的 gRPC 服務和訊息格式。

*   **RESTful API**:
    *   **用途**: Admin Server 對外提供的管理介面。
    *   **優勢**: 標準化、易於整合。

#### **4.4. 配置管理 (Configuration Management)**

*   **檔案配置**: 透過 `configs/*.yaml` 文件管理不同環境 (dev, staging, prod) 的服務設定。
*   **動態配置**: Admin Server 能夠修改 `formation_config` 等關鍵遊戲參數，並透過內部機制 (例如 gRPC 通知或共享記憶體/Redis) 即時同步到 Game Server，實現不停機更新。

### **5. 功能需求 (Functional Requirements)**

#### **5.1. 遊戲伺服器 (Game Server)**
##### **5.1.1. 連線與房間管理**
*   **[F-GS-101] 玩家連線**: 系統必須接受來自客戶端的 WebSocket 安全連線請求。
*   **[F-GS-102] 玩家認證**: 玩家連線後，應透過客戶端提供的 JWT (JSON Web Token) 進行身份驗證。此 Token 由帳號模組頒發。
*   **[F-GS-103] 創建/加入房間**: 玩家可以請求創建新房間或加入現有房間。系統應根據負載均衡策略分配玩家。
*   **[F-GS-104] 房間狀態同步**: 玩家成功進入房間後，伺服器必須立即向其同步當前房間的完整狀態。
*   **[F-GS-105] 斷線重連機制**: **TODO: V2 功能 - 待實現。需要在玩家斷線時保留其房間狀態和資料，允許玩家在一定時間內重新連線並恢復遊戲狀態。**

##### **5.1.2. 核心遊戲循環**
*   **[F-GS-201] 魚群生成**:
    *   系統應根據配置，持續在遊戲場景中生成單獨的魚。
    *   系統必須能夠根據 `formation_config` 表中的設定，在特定時間觸發複雜的 **魚群陣型 (Fish Formation)**。
    *   **[優化]** 新增 **魚潮系統 (Fish Tide System)**: **TODO: 待實現。作為一種特殊的陣型，在特定時間觸發。此時，大量特定魚群會快速、密集地游過螢幕，為玩家提供在短時間內賺取大量金幣的機會。其觸發規則、持續時間、魚種構成均可在後台配置。需要在 `FishSpawner` 中實現魚潮生成邏輯，並在資料庫中新增相應的配置表。**
    *   此功能由 `FishSpawner` 模組 (`internal/biz/game/spawner.go`) 負責。
*   **[F-GS-202] 玩家動作處理**: 處理玩家發射子彈的請求，並將此事件廣播給房間內所有其他玩家。處理玩家改變下注倍率的請求。
*   **[F-GS-203] 命中與獎勵判定**: 伺服器需進行權威性判定 (Server-Side Authoritative)，計算子彈是否命中魚。命中後，根據砲彈威力和魚的血量計算傷害。成功擊殺魚後，根據魚的價值和下注倍率計算獎勵，並更新玩家的錢包 (`wallet`) 餘額。
*   **[F-GS-204] RTP 控制**: 系統應內建 RTP (Return To Player) 控制器 (`rtp_controller.go`)，根據全局設定和當前遊戲的盈利狀況，微調魚的擊殺機率，以確保遊戲經濟模型的穩定。

##### **5.1.3. 動態配置熱更新**
*   **[F-GS-301] 監聽更新**: **TODO: 待決定技術方案。遊戲伺服器必須能監聽來自後台管理系統的配置更新通知。可選方案：(1) gRPC 推送通知 (2) Redis Pub/Sub 訂閱模式。需要評估兩種方案的優劣並選擇實現。**
*   **[F-GS-302] 即時應用**: 收到更新通知後，`GameUsecase` (`internal/biz/game/usecase.go`) 必須觸發相應的邏輯，例如命令 `FishSpawner` 重新載入最新的魚群陣型配置，並在不中斷現有遊戲的情況下應用新生效的規則。

#### **5.2. 後台管理系統 (Admin Server)**
##### **5.2.1. 儀表板與監控 (Dashboard & Monitoring)**
*   **[F-AS-101] 系統狀態查詢**: **TODO: 待實現具體監控方案。提供 API 介面，用於查詢遊戲伺服器的即時狀態，包括：總在線玩家數、當前活躍房間數、伺服器負載 (CPU, Memory)。需要實現：(1) Game Server 定期將狀態推送到 Redis (2) Admin Server 從 Redis 聚合數據並提供 API 端點 (3) 可選：整合 Prometheus + Grafana 進行更完善的監控和視覺化。**

##### **5.2.2. 遊戲配置管理 (Game Configuration Management)**
*   **[F-AS-201] 魚種管理**: 提供對魚種資料表的 CRUD (Create, Read, Update, Delete) API。可配置參數包括：魚的名稱、模型、血量、基礎獎勵倍率等。
*   **[F-AS-202] 魚群陣型管理**:
    *   提供對 `formation_config` 表的 CRUD API。
    *   允許營運人員設計新的魚群陣型，定義陣型中包含的魚種、數量、移動路徑、觸發時機等。
    *   此功能由 `formation_handlers.go` (`internal/app/admin/formation_handlers.go`) 提供核心介面。
*   **[F-AS-203] RTP/難度管理**: 提供 API 介面，用於設定全局的 RTP 百分比或遊戲難度等級。

##### **5.2.3. 配置發布 (Configuration Deployment)**
*   **[F-AS-301] 發布配置**: 提供一個 "Publish" 或 "Deploy" API，當營運人員完成配置修改後，可觸發此 API 將變更推送至所有線上遊戲伺服器，觸發 `[F-GS-301]` 的熱更新流程。

#### **5.3. [新增] 帳號模組 (Account Module)** **TODO: 整個模組待實現**
*   **[F-AM-101] 使用者註冊**: **TODO: 待實現。** 提供 API 讓使用者透過使用者名稱和密碼註冊新帳號。
*   **[F-AM-102] 使用者登入**: **TODO: 待實現。** 支援多種登入方式，並頒發 JWT。
*   **[F-AM-103] 使用者資料管理**: **TODO: 待實現。** 提供 API 查詢與更新使用者基本資料（暱稱、頭像等）。
*   **技術方案**:
    *   **服務歸屬**: 帳號相關的 REST API 可整合在 **Admin Server** 中，或在未來獨立為一個 `account-service`。初期建議整合在 Admin Server。
    *   **資料庫**: **TODO: 待建立。** 在 PostgreSQL 中建立 `users` 表，包含 `id`, `username`, `password_hash`, `nickname`, `avatar_url`, `third_party_provider`, `third_party_id` 等欄位。需要建立相應的 migration 檔案。
    *   **密碼安全**: 使用 Go 的 `golang.org/x/crypto/bcrypt` 庫對使用者密碼進行雜湊儲存。
    *   **遊客登入**: **TODO: 待實現。** 客戶端請求遊客登入時，伺服器生成唯一 guest ID，在 `users` 表中創建一筆臨時記錄，並頒發一個包含 `is_guest: true` 標記的 JWT。
    *   **第三方登入 (OAuth 2.0)**: **TODO: 待實現。**
        1.  客戶端完成第三方平台（如 Google, Facebook, QQ）的 OAuth 流程，獲得 `authorization_code`。
        2.  客戶端將此 `code` 發送至我方伺服器的 `/auth/oauth/callback` 端點。
        3.  伺服器使用 `code` 向第三方平台換取 `access_token`，進而獲取使用者資訊。
        4.  伺服器根據第三方平台的 `user_id` 查找或創建使用者，並頒發我方系統的 JWT。
    *   **Token 管理**: **TODO: 待擴展。** 擴展現有的 `internal/pkg/token`，使其能生成包含 `user_id`, `exp` (過期時間) 等標準聲明的 JWT。

#### **5.4. [新增] 大廳模組 (Lobby Module)** **TODO: 整個模組待實現**
*   **[F-LM-101] 遊戲房間列表**: **TODO: 待實現。** 提供 API 讓玩家能看到不同倍率/等級的遊戲房間列表，包含房間名稱、當前人數、進入限制等。
*   **[F-LM-102] 玩家狀態顯示**: **TODO: 待實現。** 提供 API 讓玩家在大廳能看到自己的金幣數量、等級等核心資訊。
*   **[F-LM-103] 公告與訊息**: **TODO: 待實現。** 提供 API 獲取遊戲公告或活動訊息。
*   **技術方案**:
    *   **服務歸屬**: 大廳功能為請求-響應模式，其 REST API 應整合在 **Admin Server** 中。
    *   **房間列表實現**: **TODO: 待實現。**
        1.  各 **Game Server** 實例定期 (如每 5 秒) 將其管理的房間狀態 (房間 ID, 當前人數, 負載等) 寫入 **Redis** 的一個 Hash 或 Sorted Set 中。
        2.  Admin Server 的 `/lobby/rooms` 端點從 Redis 讀取並匯總所有 Game Server 的房間資訊，形成完整的列表返回給客戶端。此方案擴展性好，且服務間解耦。
    *   **公告功能**: **TODO: 待建立。** 在 PostgreSQL 中建立 `announcements` 表，Admin Server 提供對應的 CRUD 介面進行管理，大廳 API 則從中讀取最新公告。需要建立相應的 migration 檔案。

### **6. 非功能性需求 (Non-Functional Requirements)**

*   **6.1. 效能 (Performance)**
    *   **[NF-101] 延遲**: 在正常的網路條件下，客戶端發送指令到伺服器響應的 P95 延遲應低於 150ms。
    *   **[NF-102] 併發**: 單一 Game Server 實例應能穩定支援至少 500 個併發玩家連線。
    *   **[NF-103] CPU/記憶體**: 在滿載情況下，單一服務實例的 CPU 使用率應不超過 80%，並保持穩定的記憶體用量。
*   **6.2. 可用性 (Availability)**
    *   **[NF-201] 服務在線率**: 核心遊戲服務的目標在線率為 99.9%。
    *   **[NF-202] 容錯**: 系統應具備一定的容錯能力。單一 Game Server 實例的崩潰不應影響到其他服務實例。
    *   **[NF-203] 備份與恢復**: PostgreSQL 資料庫需要設定每日自動備份策略，並具備災難恢復計畫。
*   **6.3. 可擴展性 (Scalability)**
    *   **[NF-301] 水平擴展**: Game Server 必須設計為無狀態或狀態輕量化，以便透過增加服務實例的方式進行水平擴展。
    *   **[NF-302] 資料庫擴展**: 資料庫讀取應能透過讀寫分離、增加唯讀副本的方式進行擴展。
*   **6.4. 安全性 (Security)**
    *   **[NF-401] 通訊加密**: 所有客戶端與伺服器之間的通訊 (WebSocket, REST API) 都必須使用 TLS/SSL (WSS, HTTPS) 進行加密。
    *   **[NF-402] API 保護**: Admin Server 的所有 API 都必須經過嚴格的身份驗證和權限控管。
    *   **[NF-403] 防作弊**: 核心遊戲邏輯（如命中判定、獎勵計算）必須在伺服器端進行權威性驗證，防止客戶端作弊。
*   **6.5. [新增] 使用者體驗 (User Experience)**
    *   **[NF-501] 視覺與音效**: 客戶端應配有流暢的動畫與應景的音效，以增強打擊感。客戶端開發應注重資源優化（如使用 Sprite Sheets, 壓縮音訊），確保快速載入和流暢運行。

### **7. 未來展望 (Future Roadmap)**
*   **[V2] 斷線重連機制**: 完善 `[F-GS-105]`，提供完整的斷線重連體驗。
*   **[V2] 道具系統**: 增加多樣化的遊戲道具，例如「鎖定」、「冰凍」、「加速射擊」等，並提供相應的後台配置。
*   **[V2] [新增] 好友與聊天系統**:
    *   允許玩家添加好友、發送私人訊息。
    *   **技術方向**: 可考慮建立一個獨立的 `social-service`，使用 WebSocket 處理即時訊息，並在 PostgreSQL 中建立 `friendships` 和 `messages` 表。
*   **[V2] [新增] 每日簽到與任務系統**:
    *   增加每日簽到獎勵和成就任務，以提升玩家留存率。
    *   **技術方向**: 可在 Admin Server (或獨立的 `quest-service`) 中實現邏輯，在 PostgreSQL 中建立 `check_ins` 和 `user_tasks` 表來追蹤玩家進度。
*   **[V2] 排行榜功能**: 增加基於每日/每週/總獲取金幣的排行榜。
*   **[V3] 公會系統**: 允許玩家組建公會，並推出公會專屬的活動或 Boss。
*   **[V3] 觀戰模式**: 允許其他玩家進入房間進行觀戰。
*   **[V3] 數據分析平台**: 建立一個更完善的數據後台，用於分析玩家行為、留存率、付費轉換率等，為營運決策提供數據支持。
*   **[V3] [新增] 原生 App 版本**: 考慮推出原生手機 App 版本 (iOS/Android)，以觸及更廣泛的市場。